/* ===========================================================================
   Games Layer
   =========================================================================== */

@layer games {
    .game-view {
        min-height: 100dvh;
        background: var(--game-bg, var(--color-bg));
        position: fixed !important;
        inset: 0;
        z-index: 9999 !important;
        /* Force true full screen */
        transform: translateZ(1000px);
        /* Hardware acceleration over Safari shell layers */
        overflow: hidden;
    }

    .game-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4);
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        gap: var(--space-3);
        flex-wrap: wrap;
    }

    .game-header h2 {
        flex: 1;
        margin: 0;
        text-align: center;
        font-family: var(--font-display);
        font-size: clamp(1.4rem, 3vw, 2rem);
        letter-spacing: 0.02em;
        text-wrap: balance;
    }

    .game-header .back-btn {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.9);
        color: var(--color-text);
        font-weight: 700;
    }

    .game-score {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 10px 18px rgba(120, 60, 40, 0.18);
        font-size: var(--text-lg);
        font-weight: 700;
        white-space: nowrap;
        line-height: 1.1;
    }

    .difficulty-badge {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 227, 200, 0.8));
        color: var(--color-text);
        font-size: var(--text-sm);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        box-shadow: 0 8px 16px rgba(120, 60, 40, 0.16);
    }

    .difficulty-badge[data-level='easy'] {
        background: linear-gradient(135deg, rgba(236, 255, 244, 0.95), rgba(187, 248, 220, 0.9));
        color: #20644a;
    }

    .difficulty-badge[data-level='medium'] {
        background: linear-gradient(135deg, rgba(255, 248, 232, 0.98), rgba(255, 214, 170, 0.88));
        color: #7a4a24;
    }

    .difficulty-badge[data-level='hard'] {
        background: linear-gradient(135deg, rgba(255, 236, 236, 0.98), rgba(255, 188, 188, 0.9));
        color: #7a2832;
    }

    .game-header-actions {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .game-timer {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.85);
        font-weight: 800;
        letter-spacing: 0.08em;
        font-size: var(--text-sm);
        color: var(--color-text);
        box-shadow: 0 8px 16px rgba(120, 60, 40, 0.16);
    }

    .game-coach {
        display: grid;
        gap: var(--space-3);
        padding: clamp(1rem, 4vw, 2rem);
        border-radius: var(--radius-2xl);
        background: rgba(255, 250, 245, 0.85);
        box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.8);

        /* Phase 19: Absolute floating modal centered over game */
        position: absolute;
        inset: 0;
        margin: auto;
        max-width: 540px;
        height: max-content;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        z-index: 10000;
        pointer-events: auto;

        /* Glass blur over the canvas */
        backdrop-filter: blur(32px) saturate(180%);
        -webkit-backdrop-filter: blur(32px) saturate(180%);
        border: 2px solid rgba(255, 255, 255, 0.5);

        transition: all 0.4s var(--ease-spring);
    }

    [data-session="active"] .game-coach {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
        pointer-events: none;
        visibility: hidden;
    }

    .game-coach-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
        flex-wrap: wrap;
    }

    .game-coach-kicker {
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-weight: 800;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    .game-coach-header h3 {
        margin: var(--space-1) 0;
        font-size: var(--text-lg);
        font-weight: 800;
        color: var(--color-text);
    }

    .game-coach-goal {
        margin: 0;
        color: var(--color-text-muted);
        font-weight: 700;
        font-size: var(--text-sm);
    }

    .game-coach-badge {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, rgba(255, 236, 216, 0.95), rgba(255, 196, 148, 0.9));
        font-weight: 800;
        color: #7a4a24;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: var(--text-xs);
    }

    .game-coach-steps {
        display: grid;
        gap: var(--space-2);
    }

    .game-coach-step {
        display: grid;
        grid-template-columns: auto auto 1fr;
        gap: var(--space-2);
        align-items: center;
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.7);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.85);
    }

    .game-coach-step-index {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-weight: 800;
        background: rgba(255, 231, 206, 0.9);
        color: #7a4a24;
    }

    .game-coach-step-time {
        font-weight: 800;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        white-space: nowrap;
    }

    .game-coach-step-text {
        font-weight: 700;
        color: var(--color-text);
    }

    .game-coach-step-cue {
        grid-column: 2 / -1;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: -4px;
    }

    .game-session {
        display: grid;
        gap: var(--space-2);
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.75);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    .game-session-row {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        flex-wrap: wrap;
        font-weight: 700;
        color: var(--color-text);
    }

    .game-session-label {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    .game-session-time {
        font-weight: 800;
        letter-spacing: 0.08em;
    }

    .game-session-target {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    .game-session-track {
        height: 10px;
        border-radius: var(--radius-full);
        background: rgba(255, 224, 193, 0.6);
        overflow: hidden;
    }

    .game-session-fill {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #ffb65f, #ff7a6c);
        border-radius: var(--radius-full);
        transition: width 0.3s ease;
    }

    .game-session-actions {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .game-coach-tip {
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        background: rgba(255, 248, 236, 0.9);
        font-size: var(--text-sm);
        font-weight: 700;
        color: #7a4a24;
    }

    .game-coach-tip span {
        font-weight: 800;
        margin-right: var(--space-1);
    }

    @media (max-width: 560px) {
        .game-header {
            row-gap: var(--space-2);
            justify-content: center;
        }

        .game-header .back-btn {
            order: 1;
        }

        .game-header h2 {
            order: 2;
            flex-basis: 100%;
        }

        .game-score {
            order: 3;
            width: 100%;
            text-align: center;
        }

        .difficulty-badge {
            order: 4;
            width: 100%;
            text-align: center;
        }
    }

    .game-tip {
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: var(--space-3);
        background: rgba(255, 255, 255, 0.4);
    }

    .game-tip summary {
        cursor: pointer;
        font-weight: 700;
    }

    .game-tip-list {
        margin: var(--space-3) 0 0;
        padding-left: var(--space-5);
        color: var(--color-text-muted);
        font-size: var(--text-sm);
    }

    .rhythm-controls {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .rhythm-status {
        flex-basis: 100%;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
        text-align: center;
    }

    .game-settings-popover {
        width: min(320px, 90vw);
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        box-shadow: 0 18px 32px rgba(120, 60, 40, 0.18);
        display: grid;
        gap: var(--space-3);
    }

    .game-settings-popover h3 {
        margin: 0;
        font-size: var(--text-lg);
        color: var(--color-text);
    }

    .settings-row {
        display: grid;
        gap: var(--space-2);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .settings-row input[type="range"] {
        width: 100%;
    }

    .settings-value {
        font-weight: 800;
        color: var(--color-text);
    }

    .rhythm-dash-stage {
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        background: radial-gradient(circle at top, rgba(255, 236, 200, 0.9), rgba(190, 128, 214, 0.35)),
            linear-gradient(135deg, rgba(120, 80, 170, 0.35), rgba(252, 210, 140, 0.35));
        display: grid;
        gap: var(--space-4);
        position: relative;
        overflow: hidden;
        --beat-interval: 0.5s;
        --beat-cycle: calc(var(--beat-interval) * 8);
    }

    .rhythm-level-banner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 10px 20px rgba(120, 80, 170, 0.15);
        z-index: 2;
    }

    .rhythm-level-banner h3 {
        margin: 0;
        font-size: var(--text-lg);
        color: var(--color-text);
    }

    .rhythm-bpm-display {
        font-weight: 800;
        color: var(--color-primary);
        font-size: var(--text-base);
    }

    .rhythm-energy-container {
        width: 100%;
        height: 12px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: var(--radius-full);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: var(--space-2);
        z-index: 2;
    }

    .rhythm-energy-bar {
        height: 100%;
        background: linear-gradient(90deg, #EF5A5A, #F9C74F, #31D0A0);
        transition: width 0.3s ease-out, background-color 0.3s;
    }

    .rhythm-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
    }

    .icon-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        transition: transform var(--duration-fast) var(--ease-out), box-shadow var(--duration-fast) var(--ease-out);
        touch-action: manipulation;
    }

    .icon-btn:active {
        transform: scale(0.96);
    }

    .icon-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .rhythm-scoreboard {
        display: flex;
        gap: var(--space-3);
        padding: var(--space-2) var(--space-4);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.7);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        flex-wrap: wrap;
    }

    .rhythm-score-block {
        text-align: center;
        min-width: 88px;
    }

    .rhythm-score-label {
        display: block;
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        line-height: 1.1;
    }

    .rhythm-score-value {
        font-size: var(--text-xl);
        font-weight: 800;
        color: var(--color-text);
        line-height: 1.1;
    }

    .rhythm-lanes {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--space-2);
        padding: var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.65);
        min-height: 240px;
    }

    .rhythm-lane {
        position: relative;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.5);
        overflow: hidden;
    }

    .rhythm-note {
        position: absolute;
        left: 50%;
        top: -18%;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        transform: translateX(-50%);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        opacity: 0;
        animation: rhythm-fall var(--beat-cycle) linear infinite;
        animation-delay: var(--note-delay, 0s);
        animation-play-state: paused;
    }

    .rhythm-dash-stage.is-running .rhythm-note,
    .rhythm-run-toggle:checked~.rhythm-dash-stage .rhythm-note {
        animation-play-state: running;
    }

    #rhythm-run:not(:checked)~.rhythm-dash-stage .btn-stop {
        display: none;
    }

    #rhythm-run:checked~.rhythm-dash-stage .btn-start {
        display: none;
    }

    .note-blue {
        background: linear-gradient(135deg, #7ad3ff, #4d78ff);
    }

    .note-green {
        background: linear-gradient(135deg, #6fe7c8, #3bb39a);
    }

    .note-yellow {
        background: linear-gradient(135deg, #ffe07a, #ffb14b);
    }

    .note-red {
        background: linear-gradient(135deg, #ff9aa2, #ff5b73);
    }

    .rhythm-hit-zone {
        text-align: center;
        font-weight: 700;
        padding: var(--space-2);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.7);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        line-height: 1.2;
    }

    .rhythm-dash-stage:has(.rhythm-tap:active) .rhythm-hit-zone {
        transform: scale(0.98);
        box-shadow: 0 10px 18px rgba(120, 60, 40, 0.22);
    }

    .rhythm-meta {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        line-height: 1.2;
    }

    .rhythm-rating {
        font-size: var(--text-xs);
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--color-text-muted);
    }

    .rhythm-rating[data-level="perfect"] {
        color: #ff7b7b;
    }

    .rhythm-rating[data-level="great"] {
        color: #ffb14b;
    }

    .rhythm-rating[data-level="good"] {
        color: #3fb39b;
    }

    .rhythm-rating[data-level="off"] {
        color: #7a7a7a;
    }

    .rhythm-meter {
        width: min(220px, 100%);
        height: 8px;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.7);
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.5);
    }

    .rhythm-meter-fill {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #ff7b7b, #ffd166, #6ee7b7);
        transition: width var(--duration-fast) var(--ease-out);
    }

    @keyframes rhythm-fall {
        0% {
            opacity: 0;
            transform: translate(-50%, -30%);
        }

        15% {
            opacity: 1;
        }

        100% {
            opacity: 0.9;
            transform: translate(-50%, 280px);
        }
    }

    .memory-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--space-3);
    }

    .memory-card {
        position: relative;
    }

    .memory-card input {
        position: absolute;
        inset: 0;
        opacity: 0;
    }

    .memory-card label {
        display: block;
        position: relative;
        aspect-ratio: 1 / 1;
        transform-style: preserve-3d;
        transition: transform 0.6s ease;
    }

    .memory-card input:checked+label {
        transform: rotateY(180deg);
    }

    .memory-front,
    .memory-back {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        border-radius: var(--radius-lg);
        backface-visibility: hidden;
        font-size: 1.8rem;
        font-weight: 800;
        border: 1px solid var(--glass-border);
    }

    .memory-front {
        background: var(--glass-bg);
    }

    .memory-back {
        background: var(--color-primary);
        color: #fff;
        transform: rotateY(180deg);
    }

    /* Pitch Quest */
    .pitch-quest-stage {
        display: grid;
        gap: var(--space-4);
        place-items: center;
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: radial-gradient(circle at top, rgba(255, 236, 214, 0.95), rgba(244, 170, 118, 0.85) 55%, rgba(239, 110, 84, 0.85));
        box-shadow: var(--glass-shadow);
        position: relative;
        overflow: hidden;
    }

    .pitch-targets-group {
        border: 0;
        margin: 0;
        padding: 0;
        min-inline-size: 0;
    }

    .pitch-targets {
        display: grid;
        gap: var(--space-2);
        justify-items: center;
        margin-bottom: var(--space-3);
    }

    .pitch-target-label {
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--color-text-muted);
        font-weight: 700;
        line-height: 1.1;
    }

    .pitch-target-options {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
        justify-content: center;
    }

    .pitch-target-options .note-btn {
        cursor: pointer;
    }

    .pitch-target-status {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
        text-align: center;
    }

    .pitch-quest-stage::before {
        content: '';
        position: absolute;
        inset: -40%;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), transparent 60%);
        opacity: 0.7;
        pointer-events: none;
    }

    .pitch-scoreboard {
        width: min(360px, 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: var(--space-2);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.7);
        box-shadow: 0 14px 28px rgba(120, 60, 40, 0.2);
        z-index: 1;
    }

    .pitch-score {
        font-weight: 800;
        font-size: var(--text-base);
        line-height: 1.2;
    }

    .pitch-score span {
        display: block;
        font-size: var(--text-2xl);
        line-height: 1.1;
    }

    .pitch-stars {
        font-size: 1.2rem;
        letter-spacing: 0.12em;
        color: #fff4c2;
        text-shadow: 0 4px 10px rgba(90, 50, 35, 0.35);
        line-height: 1;
    }

    .pitch-stability {
        text-align: right;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 700;
        line-height: 1.1;
    }

    .pitch-stability span {
        display: block;
        font-size: var(--text-lg);
        color: #ff7b7b;
    }

    .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        /* very subtle white */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-2xl);
        padding: var(--space-4);
        position: absolute;
        /* float over canvas */
        bottom: max(var(--space-6), env(safe-area-inset-bottom, var(--space-4)));
        /* dynamic safe area inset */
        left: 50%;
        transform: translateX(-50%);
        /* perfectly centered */
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        color: var(--color-text);
        z-index: 100;
        width: min(calc(100vw - var(--space-6)), 400px) !important;
        pointer-events: auto;
        /* Ensure controls are clickable */
    }

    .bamboo-container {
        width: 48px;
        height: 160px;
        background: rgba(49, 208, 160, 0.15);
        border-radius: var(--radius-full);
        position: relative;
        overflow: hidden;
        margin: 0 auto;
        border: 4px solid var(--color-success);
        box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.15), 0 8px 16px rgba(49, 208, 160, 0.2);
        z-index: 1;
    }

    .bamboo-stalk {
        width: 100%;
        height: var(--bamboo-fill, 0%);
        background: linear-gradient(to top, #27ad85, #6EE7B7);
        position: absolute;
        bottom: 0;
        transition: height 0.2s ease-out;
        box-shadow: inset 0 4px 8px rgba(255, 255, 255, 0.4);
    }

    .pitch-gauge {
        width: min(260px, 100%);
        aspect-ratio: 2 / 1;
        position: relative;
        z-index: 1;
        --pitch-angle: 0deg;
        --pitch-offset: 0deg;
    }

    .pitch-arc {
        position: absolute;
        inset: 0;
        border-radius: 999px 999px 24px 24px;
        background: conic-gradient(from 180deg, #ff7b7b, #ffd166, #6ee7b7);
        -webkit-mask: radial-gradient(circle, transparent 58%, #000 59%);
        mask: radial-gradient(circle, transparent 58%, #000 59%);
        clip-path: inset(0 0 50% 0);
        opacity: 0.9;
    }

    .pitch-note {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        display: grid;
        place-items: center;
        font-size: var(--text-2xl);
        font-weight: 800;
        box-shadow: 0 14px 24px rgba(120, 60, 40, 0.2);
        line-height: 1.1;
    }

    .pitch-target {
        display: none;
    }

    #pitch-target-g:checked~.pitch-quest-stage .pitch-target--g,
    #pitch-target-d:checked~.pitch-quest-stage .pitch-target--d,
    #pitch-target-a:checked~.pitch-quest-stage .pitch-target--a,
    #pitch-target-e:checked~.pitch-quest-stage .pitch-target--e {
        display: inline;
    }

    #pitch-target-g:checked~.pitch-quest-stage .pitch-gauge {
        --pitch-angle: -28deg;
    }

    #pitch-target-d:checked~.pitch-quest-stage .pitch-gauge {
        --pitch-angle: -10deg;
    }

    #pitch-target-a:checked~.pitch-quest-stage .pitch-gauge {
        --pitch-angle: 8deg;
    }

    #pitch-target-e:checked~.pitch-quest-stage .pitch-gauge {
        --pitch-angle: 26deg;
    }

    .pitch-audio {
        width: min(360px, 100%);
    }

    .pitch-audio summary {
        cursor: pointer;
        font-weight: 700;
    }

    .pitch-needle {
        position: absolute;
        bottom: 12px;
        left: 50%;
        width: 6px;
        height: 90px;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.9);
        transform: translateX(-50%) rotate(calc(var(--pitch-angle) + var(--pitch-offset)));
        transform-origin: bottom center;
        box-shadow: 0 8px 14px rgba(120, 60, 40, 0.25);
    }

    .pitch-needle::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--color-primary);
        transform: translateX(-50%);
        box-shadow: 0 6px 12px rgba(120, 60, 40, 0.3);
    }

    .pitch-controls {
        width: min(360px, 100%);
        display: grid;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.78);
        box-shadow: 0 16px 28px rgba(120, 60, 40, 0.18);
        z-index: 1;
    }

    .pitch-slider {
        display: grid;
        gap: var(--space-2);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .pitch-readout {
        font-weight: 800;
        color: var(--color-text);
    }

    .pitch-actions {
        display: grid;
        gap: var(--space-2);
    }

    .pitch-feedback {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
    }

    .note-btn {
        padding: var(--space-2) 0;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.85);
        border: 2px solid rgba(255, 255, 255, 0.8);
        font-weight: 800;
        box-shadow: 0 10px 18px rgba(120, 60, 40, 0.2);
        transition: transform var(--duration-fast) var(--ease-out);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 56px;
    }

    .note-btn:active {
        transform: scale(0.96);
    }

    /* Note Memory */
    .note-memory-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(191, 170, 242, 0.6), rgba(237, 229, 255, 0.9));
        box-shadow: var(--glass-shadow);
    }

    .memory-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
        line-height: 1.2;
    }

    .memory-timer {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.9);
        font-weight: 800;
        line-height: 1.1;
    }

    .memory-meta {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        line-height: 1.2;
    }

    .memory-reset.btn {
        padding: var(--space-1) var(--space-3);
        font-size: var(--text-xs);
        border-radius: var(--radius-full);
    }

    .memory-front {
        background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.9), rgba(226, 212, 255, 0.9));
        color: var(--color-text-muted);
    }

    .memory-back {
        background: linear-gradient(135deg, #f8b35f, #f57f63);
        color: #fff;
    }

    .memory-card.is-matched label {
        box-shadow: 0 12px 22px rgba(249, 199, 79, 0.35);
    }

    /* Ear Trainer */
    .ear-trainer-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(171, 227, 220, 0.9), rgba(223, 245, 242, 0.95));
        box-shadow: var(--glass-shadow);
    }

    .ear-progress {
        display: grid;
        grid-template-columns: repeat(10, minmax(0, 1fr));
        gap: var(--space-1);
    }

    .ear-dot {
        height: 10px;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.7);
    }

    .ear-dot.is-active {
        background: var(--color-primary);
    }

    .ear-dot.is-correct {
        background: var(--color-success);
    }

    .ear-dot.is-wrong {
        background: var(--color-error);
    }

    .ear-dot.is-disabled {
        opacity: 0.35;
        filter: grayscale(0.35);
    }

    .ear-question {
        text-align: center;
        font-weight: 700;
        color: var(--color-text-muted);
        line-height: 1.2;
    }

    .ear-streak {
        text-align: center;
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .ear-panel {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.7);
        box-shadow: 0 12px 22px rgba(90, 120, 120, 0.15);
    }

    .ear-icon {
        font-size: 2.2rem;
    }

    .ear-options {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: var(--space-3);
        border: 0;
        margin: 0;
        padding: 0;
        min-inline-size: 0;
    }

    .ear-choice {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .ear-option {
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.8);
        font-weight: 800;
        text-align: center;
        box-shadow: 0 10px 18px rgba(90, 120, 120, 0.18);
        transition: transform var(--duration-fast) var(--ease-out);
        line-height: 1.1;
    }

    .ear-option:active {
        transform: scale(0.96);
    }

    .ear-choice:checked+.ear-option {
        background: var(--color-primary);
        color: #fff;
        transform: translateY(-2px);
    }

    /* Bow Hero */
    .bow-hero-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(146, 214, 198, 0.9), rgba(217, 243, 233, 0.95));
        box-shadow: var(--glass-shadow);
        place-items: center;
    }

    .bow-hero-hud {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.7);
        font-weight: 700;
        line-height: 1.2;
    }

    .bow-timer {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.9);
        font-weight: 800;
        line-height: 1.1;
    }

    .bow-arc {
        width: min(320px, 100%);
        aspect-ratio: 2 / 1;
        position: relative;
    }

    .bow-arc-track {
        position: absolute;
        inset: 0;
        border-radius: 999px 999px 0 0;
        border: 10px solid rgba(255, 255, 255, 0.7);
        border-bottom: none;
        background: linear-gradient(90deg, rgba(102, 211, 190, 0.3), rgba(255, 255, 255, 0.6));
    }

    .bow-arc-indicator {
        position: absolute;
        left: 50%;
        bottom: 0;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #f7c36b;
        box-shadow: 0 8px 16px rgba(90, 120, 120, 0.25);
        transform: translate(-50%, 50%) rotate(var(--bow-angle, -90deg)) translateY(-130px);
        transform-origin: center;
    }

    .bow-run-toggle:checked~.bow-hero-stage .bow-arc-indicator {
        animation: bow-sweep 2.6s ease-in-out infinite;
    }

    #bow-hero-run:not(:checked)~.bow-hero-stage .btn-stop {
        display: none;
    }

    #bow-hero-run:checked~.bow-hero-stage .btn-start {
        display: none;
    }

    .bow-hero-stage:has(.bow-stroke:active) .bow-stars {
        transform: scale(1.03);
    }

    @keyframes bow-sweep {
        0% {
            transform: translate(-50%, 50%) rotate(-70deg) translateY(-130px);
        }

        50% {
            transform: translate(-50%, 50%) rotate(70deg) translateY(-130px);
        }

        100% {
            transform: translate(-50%, 50%) rotate(-70deg) translateY(-130px);
        }
    }

    .bow-stars {
        display: flex;
        gap: var(--space-2);
        font-size: 1.6rem;
        color: rgba(255, 255, 255, 0.6);
        line-height: 1;
    }

    .bow-stars-badge {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.7);
        font-weight: 700;
        font-size: var(--text-sm);
        line-height: 1.2;
    }

    .bow-star.is-lit {
        color: #f7d46b;
        text-shadow: 0 6px 10px rgba(120, 90, 40, 0.3);
    }

    .bow-controls {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
        justify-content: center;
    }

    .bow-status {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
        text-align: center;
    }

    .string-quest-stage {
        position: absolute;
        inset: 0;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: clamp(16px, 4vw, 32px) clamp(16px, 4vw, 32px) calc(var(--safe-bottom, 80px) + clamp(16px, 4vw, 32px));
        z-index: 10;
        overflow: hidden;
    }

    .string-quest-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
    }

    .string-prompt {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.7);
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text);
        text-align: center;
    }

    .string-sequence {
        text-align: center;
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .string-board {
        display: grid;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.7);
        position: relative;
    }

    .string-line {
        position: relative;
        display: flex;
        align-items: center;
        gap: var(--space-3);
        height: 36px;
        font-weight: 800;
        color: var(--color-text-muted);
        line-height: 1.1;
    }

    .string-line::after {
        content: '';
        flex: 1;
        height: 2px;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.75);
    }

    .string-label {
        width: 30px;
        text-align: center;
        line-height: 1;
    }

    .string-target {
        position: absolute;
        top: 50%;
        left: var(--target-x, 70%);
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: translate(-50%, -50%);
        opacity: 0;
    }

    .string-target.is-target {
        opacity: 1;
        background: #f7c36b;
        box-shadow: 0 10px 18px rgba(120, 70, 40, 0.3);
    }

    .string-quest-stage:has(.string-btn[data-string-btn="G"]:is(:active, :focus-visible)) .string-line[data-string="G"] .string-target,
    .string-quest-stage:has(.string-btn[data-string-btn="D"]:is(:active, :focus-visible)) .string-line[data-string="D"] .string-target,
    .string-quest-stage:has(.string-btn[data-string-btn="A"]:is(:active, :focus-visible)) .string-line[data-string="A"] .string-target,
    .string-quest-stage:has(.string-btn[data-string-btn="E"]:is(:active, :focus-visible)) .string-line[data-string="E"] .string-target {
        opacity: 1;
        background: #f7c36b;
        box-shadow: 0 10px 18px rgba(120, 70, 40, 0.3);
    }

    .string-controls {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--space-2);
    }

    /* Rhythm Painter */
    .rhythm-painter-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(219, 176, 233, 0.85), rgba(255, 228, 240, 0.95));
        box-shadow: var(--glass-shadow);
    }

    .painter-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
        line-height: 1.2;
    }

    .painter-rounds {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        font-weight: 700;
    }

    .painter-canvas {
        position: relative;
        width: min(440px, 100%);
        aspect-ratio: 4 / 3;
        border-radius: var(--radius-xl);
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(254, 214, 238, 0.85));
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    .painter-canvas::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 60% 60%, rgba(255, 214, 238, 0.6), transparent 65%);
        opacity: 0.6;
    }

    .paint-dot {
        position: absolute;
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: none;
        transform: translate(-50%, -50%);
        box-shadow: 0 10px 20px rgba(120, 60, 120, 0.25);
        transition: transform var(--duration-fast) var(--ease-out);
    }

    .paint-dot.is-hit {
        transform: translate(-50%, -50%) scale(1.08);
    }

    .paint-dot:active {
        transform: translate(-50%, -50%) scale(1.08);
    }

    .paint-dot.dot-blue {
        background: linear-gradient(135deg, #8ad2ff, #4f7cff);
        left: 22%;
        top: 45%;
    }

    .paint-dot.dot-green {
        background: linear-gradient(135deg, #7be7c6, #3fb39b);
        left: 42%;
        top: 30%;
    }

    .paint-dot.dot-yellow {
        background: linear-gradient(135deg, #ffe07a, #ffb14b);
        left: 62%;
        top: 45%;
    }

    .paint-dot.dot-red {
        background: linear-gradient(135deg, #ff9aa2, #ff5b73);
        left: 78%;
        top: 60%;
    }

    .painter-meter {
        position: relative;
        width: min(280px, 100%);
        height: 80px;
        margin: 0 auto;
    }

    .painter-status {
        text-align: center;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
    }

    .painter-meter::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 999px 999px 0 0;
        border: 8px solid rgba(255, 255, 255, 0.7);
        border-bottom: none;
    }

    .painter-needle {
        position: absolute;
        left: 50%;
        bottom: 0;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #f7b6d2;
        box-shadow: 0 8px 14px rgba(120, 70, 120, 0.25);
        transform: translate(-50%, 50%) rotate(var(--painter-angle, -90deg)) translateY(-70px);
        transform-origin: center;
    }

    /* Story Song Lab */
    .story-song-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(238, 189, 201, 0.85), rgba(255, 230, 238, 0.95));
        box-shadow: var(--glass-shadow);
        text-align: center;
    }

    .story-banner {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
        align-items: center;
        font-family: var(--font-display);
        font-size: var(--text-2xl);
        font-weight: 800;
        line-height: 1.1;
    }

    .story-page {
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
        letter-spacing: 0.04em;
        text-transform: uppercase;
    }

    .story-book {
        padding: var(--space-5);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.7);
    }

    .story-hero {
        display: grid;
        gap: var(--space-2);
        place-items: center;
        font-size: 1.4rem;
        line-height: 1.3;
    }

    .story-prompt {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        font-weight: 600;
        text-align: center;
    }

    .story-notes {
        font-size: 1.6rem;
        letter-spacing: 0.2em;
        line-height: 1;
    }

    .story-play-btn {
        justify-self: center;
    }

    .story-status {
        text-align: center;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
    }

    .story-staff {
        position: relative;
        height: 80px;
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: space-around;
        overflow: hidden;
    }

    .story-staff::before {
        content: '';
        position: absolute;
        inset: 16px 24px;
        background: repeating-linear-gradient(to bottom, rgba(120, 80, 90, 0.3) 0, rgba(120, 80, 90, 0.3) 2px, transparent 2px, transparent 10px);
        opacity: 0.6;
    }

    .story-note {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--color-primary);
        position: relative;
        z-index: 1;
        animation: story-note-float 4s linear infinite;
        animation-delay: var(--note-delay, 0s);
        animation-play-state: paused;
    }

    .story-play-toggle:checked~.story-staff .story-note {
        animation-play-state: running;
    }

    @keyframes story-note-float {
        0% {
            transform: translateY(0);
            opacity: 0.6;
        }

        40% {
            transform: translateY(-18px);
            opacity: 1;
        }

        100% {
            transform: translateY(0);
            opacity: 0.6;
        }
    }

    /* Panda Pizzicato */
    .pizzicato-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(162, 221, 228, 0.9), rgba(223, 244, 245, 0.95));
        box-shadow: var(--glass-shadow);
    }

    .pizzicato-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
        line-height: 1.2;
    }

    .pizzicato-strings {
        display: grid;
        gap: var(--space-3);
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.7);
    }

    .pizzicato-string {
        position: relative;
        display: flex;
        align-items: center;
        gap: var(--space-3);
        height: 52px;
        font-weight: 800;
        color: var(--color-text-muted);
        line-height: 1.1;
    }

    .pizzicato-string::after {
        content: '';
        position: absolute;
        left: 46px;
        right: 12px;
        top: 50%;
        height: 3px;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.75);
        transform: translateY(-50%);
    }

    .pizzicato-label {
        width: 34px;
        text-align: center;
        line-height: 1;
    }

    .pizzicato-note {
        position: absolute;
        top: 50%;
        left: var(--target-x, 70%);
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: translate(-50%, -50%);
        opacity: 0;
    }

    .pizzicato-note.is-target {
        opacity: 1;
        background: #72d1ff;
        box-shadow: 0 10px 18px rgba(70, 110, 140, 0.3);
    }

    .pizzicato-stage:has(.pizzicato-btn[data-pizzicato-btn="G"]:is(:active, :focus-visible)) .pizzicato-string[data-string="G"] .pizzicato-note,
    .pizzicato-stage:has(.pizzicato-btn[data-pizzicato-btn="D"]:is(:active, :focus-visible)) .pizzicato-string[data-string="D"] .pizzicato-note,
    .pizzicato-stage:has(.pizzicato-btn[data-pizzicato-btn="A"]:is(:active, :focus-visible)) .pizzicato-string[data-string="A"] .pizzicato-note,
    .pizzicato-stage:has(.pizzicato-btn[data-pizzicato-btn="E"]:is(:active, :focus-visible)) .pizzicato-string[data-string="E"] .pizzicato-note {
        opacity: 1;
        background: #72d1ff;
        box-shadow: 0 10px 18px rgba(70, 110, 140, 0.3);
    }

    .pizzicato-controls {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--space-2);
    }

    .pizzicato-status {
        text-align: center;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
    }

    .pizzicato-sequence {
        text-align: center;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 700;
    }

    /* Tuning Time */
    .tuning-time-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(184, 240, 228, 0.9), rgba(221, 246, 241, 0.95));
        box-shadow: var(--glass-shadow);
        text-align: center;
    }

    .tuning-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
        line-height: var(--leading-snug);
    }

    .tuning-score,
    .tuning-status {
        font-size: var(--text-sm);
    }

    .tuning-strings {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--space-2);
    }

    .tuning-progress {
        width: 100%;
        height: 8px;
        border-radius: var(--radius-full);
        background: rgba(255, 255, 255, 0.7);
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.5);
    }

    .tuning-progress-fill {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #6ee7b7, #7ad3ff);
        transition: width var(--duration-fast) var(--ease-out);
    }

    /* Melody Maker */
    .melody-maker-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(255, 214, 176, 0.9), rgba(255, 236, 214, 0.95));
        box-shadow: var(--glass-shadow);
    }

    .melody-hud {
        display: grid;
        gap: var(--space-2);
        padding: var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
        line-height: var(--leading-snug);
    }

    .melody-track {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    .melody-target {
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .melody-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: var(--space-2);
    }

    .melody-actions {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        justify-content: center;
    }

    .melody-actions .btn {
        padding: var(--space-1) var(--space-4);
        font-size: var(--text-xs);
    }

    .melody-status {
        text-align: center;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
    }

    /* Scale Practice */
    .scale-practice-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(210, 198, 255, 0.9), rgba(234, 228, 255, 0.95));
        box-shadow: var(--glass-shadow);
    }

    .scale-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
        line-height: var(--leading-snug);
    }

    .scale-tempo-control {
        display: grid;
        gap: var(--space-2);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .scale-status {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
        text-align: center;
    }

    .scale-tap-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
        flex-wrap: wrap;
    }

    .scale-rating {
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .scale-notes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        gap: var(--space-2);
        text-align: center;
    }

    .scale-note {
        padding: var(--space-2);
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 800;
    }

    /* Duet Challenge */
    .duet-challenge-stage {
        display: grid;
        gap: var(--space-4);
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        background: linear-gradient(160deg, rgba(255, 215, 192, 0.9), rgba(255, 234, 219, 0.95));
        box-shadow: var(--glass-shadow);
    }

    .duet-hud {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        font-weight: 700;
    }

    .duet-prompt {
        text-align: center;
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .duet-round {
        text-align: center;
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
    }

    .duet-panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: var(--space-3);
    }

    .duet-panel {
        display: grid;
        gap: var(--space-2);
        padding: var(--space-3);
        border-radius: var(--radius-xl);
        background: rgba(255, 255, 255, 0.75);
        text-align: center;
        font-weight: 700;
    }

    .duet-notes {
        font-size: var(--text-base);
        letter-spacing: var(--tracking-tight);
    }

    .duet-buttons {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--space-2);
    }

    .duet-audio {
        position: absolute;
        width: 0;
        height: 0;
        overflow: hidden;
        pointer-events: none;
    }

    .game-mastery-meta {
        margin-top: var(--space-2);
        padding-top: var(--space-2);
        border-top: 1px solid rgba(15, 23, 42, 0.12);
        display: grid;
        gap: 6px;
        font-size: var(--text-xs);
    }

    .game-mastery-topline {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-2);
    }

    .game-mastery-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 76px;
        padding: 2px 10px;
        border-radius: var(--radius-full);
        background: rgba(15, 23, 42, 0.08);
        color: var(--color-text);
        font-weight: 800;
        letter-spacing: 0.02em;
        text-transform: uppercase;
    }

    .game-card[data-mastery-tier="bronze"] .game-mastery-badge {
        background: linear-gradient(135deg, rgba(245, 197, 139, 0.35), rgba(210, 122, 52, 0.38));
        color: #6b3f1a;
    }

    .game-card[data-mastery-tier="silver"] .game-mastery-badge {
        background: linear-gradient(135deg, rgba(224, 231, 255, 0.65), rgba(186, 196, 223, 0.6));
        color: #334155;
    }

    .game-card[data-mastery-tier="gold"] .game-mastery-badge {
        background: linear-gradient(135deg, rgba(255, 240, 164, 0.75), rgba(251, 191, 36, 0.62));
        color: #78350f;
    }

    .game-mastery-days {
        color: var(--color-text-muted);
        font-weight: 700;
    }

    .game-mastery-objectives {
        color: var(--color-text);
        font-weight: 600;
    }

    .game-mastery-prereq {
        color: var(--color-text-muted);
        line-height: 1.35;
    }

    .games-mastery-legend {
        margin: var(--space-3) 0;
        padding: var(--space-3);
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        align-items: center;
        font-size: var(--text-sm);
    }

    .games-mastery-legend strong {
        margin-right: var(--space-1);
    }

    .games-mastery-legend small {
        width: 100%;
        color: var(--color-text-muted);
    }

    .game-objective-tiers {
        display: grid;
        gap: var(--space-2);
    }

    .game-objective-tier {
        display: grid;
        gap: 4px;
        padding: var(--space-2);
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.66);
        border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .game-objective-tier[data-tier-active="true"] {
        border-color: rgba(34, 197, 94, 0.55);
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25) inset;
    }

    .game-objective-tier-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-2);
        font-size: var(--text-xs);
        font-weight: 800;
        color: var(--color-text);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .game-objective-tier ul {
        margin: 0;
        padding-left: 16px;
        display: grid;
        gap: 2px;
        color: var(--color-text);
        font-size: var(--text-xs);
    }

    /* Full-Screen Immersion Fix: Ensure all HUDs stack above the absolute Canvases */
    [class$="-stage"]>*:not(canvas),
    [class$="-content"]>*:not(canvas),
    .game-header,
    .game-coach,
    .game-drill,
    .rhythm-controls,
    .rhythm-hud,
    .rhythm-level-banner,
    .painter-canvas,
    .painter-hud,
    .painter-status,
    .tuning-live-panel {
        position: relative;
        z-index: 50;
        pointer-events: auto;
    }
}