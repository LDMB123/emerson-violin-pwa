# Panda Violin PWA

Local-first violin practice app for iPad-focused use, with an onboarding flow, practice tools, games, coach guidance, and offline behavior.

## Current Status (February 21, 2026)

- `npm run lint:all`: passing
- `npm run test:coverage`: passing (64 files, 595 tests)
- `npm run test:e2e`: passing (47 tests)
- `npm run handoff:verify`: passing (`audit:full` + E2E)

## Stack

- Vite + vanilla ES modules
- Vitest + Playwright
- Service worker precache list generated by `scripts/build-sw-assets.js`
- IndexedDB-first persistence with localStorage fallback
- Optional WASM modules under `src/wasm/` and `wasm/`

## Development

```bash
npm install
npm run dev
```

Useful commands:

```bash
npm run handoff:status
npm run handoff:verify
npm run lint
npm run lint:all
npm test
npm run test:e2e
npx playwright test
npm run build
npm run preview
npm run audit:deadcode
npm run audit:deps
npm run audit:secrets
npm run audit:perf:config
npm run audit:view-sync
npm run audit:modules
npm run audit:a11y
npm run audit:learning
npm run audit:full
```

## Playwright Worker Tuning

`playwright.config.js` now defaults to:

- CI: `workers=1`
- local development: `workers=2`

Use `PW_WORKERS` to override per run:

```bash
PW_WORKERS=2 npm run test:e2e
PW_WORKERS=3 npx playwright test
```

Recommended starting points:

| Machine profile | Recommended `PW_WORKERS` | Notes |
| --- | --- | --- |
| CI/shared runner | `1` | Most stable for WebKit and avoids resource contention. |
| Laptop/desktop (typical dev setup) | `2` | Default local setting; preferred for `handoff:verify`. |
| High-end local workstation | `3` | Use only after calibration; reduce if hangs appear. |

Calibration flow for higher parallelism:

```bash
PW_WORKERS=3 npx playwright test tests/e2e/games-all-functional.spec.js --grep "group C: string/painter/story/pizzicato" --repeat-each=5
PW_WORKERS=3 npm run test:e2e
```

If either command hangs or intermittently times out, step down by one worker.

## Quality Gates

- Dead code and unused exports are checked by `knip` using `knip.json`.
- Duplicate dependency versions are checked by `scripts/audit-dependency-duplicates.mjs`.
- Secret/credential pattern leakage is checked by `scripts/audit-secrets.mjs`.
- Performance budget config drift is checked by `scripts/audit-performance-budget-config.mjs`.
- CI runs `lint:all`, dead-code/dependency/security audits, production dependency vulnerability audit, unit tests, build, performance budget checks, and Playwright E2E on PRs and pushes to `main`.
- Detailed handoff/debug report: `docs/plans/2026-02-18-debug-optimization-report.md`.
- Operator runbook for zero-context pickup: `docs/HANDOFF.md`.

## Architecture Notes

- App shell lives in `index.html`; routed view content is loaded into `#main-content`.
- Views are loaded from `public/views/**` by `src/views/view-loader.js`.
- Active view visibility is JS-driven via `.view.is-active` (not solely CSS `:target`).
- Idle/secondary modules are queued with `requestIdleCallback` fallback.
- Audio file URLs in loaded views are rewritten at render-time via `getAudioPath()`.

## Project Layout

```text
src/            App logic, styles, platform/audio/game modules
public/         Runtime static assets (including lazy-loaded view HTML)
tests/          Unit and E2E tests
docs/           Guides and implementation plans
scripts/        Build/precache/optimization utilities
wasm/           Rust source for WASM modules
```

## Important Caveat

View extraction from `index.html` has been retired; view parity is now enforced via `npm run audit:view-sync` against `public/views/home.html`.
