name: CI

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install system tools
        run: |
          if ! command -v wasm-opt >/dev/null 2>&1; then
            for attempt in 1 2 3; do
              echo "Installing binaryen (attempt ${attempt}/3)"
              if timeout 180s sudo apt-get update \
                && timeout 180s sudo apt-get install -y --no-install-recommends binaryen; then
                break
              fi
              echo "binaryen install attempt ${attempt} failed; retrying..."
              sleep 5
            done
          else
            echo "binaryen already available (wasm-opt found)"
          fi

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install Trunk
        run: |
          set -euo pipefail
          TRUNK_VERSION="v0.21.14"
          TRUNK_ARCHIVE="trunk-$(uname -m)-unknown-linux-gnu.tar.gz"
          TRUNK_URL="https://github.com/thedodd/trunk/releases/download/${TRUNK_VERSION}/${TRUNK_ARCHIVE}"
          CHECKSUM_URL="${TRUNK_URL}.sha256"
          curl -fsSL "${TRUNK_URL}" -o /tmp/trunk.tar.gz
          curl -fsSL "${CHECKSUM_URL}" -o /tmp/trunk.tar.gz.sha256
          echo "$(cat /tmp/trunk.tar.gz.sha256)  /tmp/trunk.tar.gz" | sha256sum -c -
          tar -xzf /tmp/trunk.tar.gz -C /tmp
          sudo mv /tmp/trunk /usr/local/bin/trunk
          trunk --version

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm test

      - name: Install Playwright browser
        run: npx playwright install chromium

      - name: Visual regression tests
        run: npm run test:visual

      - name: Rust check
        run: cargo check

      - name: Production build
        run: npm run build

      - name: Budget gate
        run: npm run build:budgets
