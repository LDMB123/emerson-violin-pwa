# Code Splitting & Lazy Loading Design

Date: 2026-02-15
Status: Approved
Audit refs: H12, M13, M14, M16

## Problem

Initial payload includes assets unused by most page views:
- 47KB WASM loaded at boot via progress.js (M16)
- 44KB game-metrics.js monolith for all 13 games (M13)
- 123KB CSS with game-specific rules loaded upfront (M14)
- 173KB index.html with all 22 views inline (H12)

## Priority Order

1. **M16 — WASM lazy init** (easiest, 47KB/20KB gzip savings)
2. **M13 — Per-game JS split** (44KB monolith → ~3KB per game)
3. **M14 — Per-game CSS split** (piggybacks on M13)
4. **H12 — HTML template extraction** (DX improvement, no payload change)

## Design

### M16: Defer WASM Loading

`progress.js` currently has top-level `import initCore, { ... } from '../wasm/panda_core.js'` which triggers immediate WASM fetch at boot.

Change to lazy-init pattern:
```js
let wasmModule = null;
const getCore = async () => {
    if (!wasmModule) {
        const mod = await import('../wasm/panda_core.js');
        await mod.default();
        wasmModule = mod;
    }
    return wasmModule;
};
```

Every function that uses WASM classes (PlayerProgress, AchievementTracker, SkillProfile, etc.) calls `await getCore()` first. The module caches after first load.

`session-review.js` also imports panda_core but is already lazy-loaded (only on view-session-review), so apply same pattern there for consistency.

Files changed: `src/progress/progress.js`, `src/analysis/session-review.js`

### M13: Per-Game Metrics Split

Split `src/games/game-metrics.js` (2,851 lines, 13 games) into:

```
src/games/metrics/shared.js          — cachedEl, formatStars, tonePlayer, event tracking, formatCountdown
src/games/metrics/pitch-quest.js
src/games/metrics/rhythm-dash.js
src/games/metrics/note-memory.js
src/games/metrics/ear-trainer.js
src/games/metrics/bow-hero.js
src/games/metrics/string-quest.js
src/games/metrics/rhythm-painter.js
src/games/metrics/story-song.js
src/games/metrics/pizzicato.js
src/games/metrics/tuning-time.js
src/games/metrics/melody-maker.js
src/games/metrics/scale-practice.js
src/games/metrics/duet-challenge.js
```

`src/games/game-metrics.js` becomes a thin router:
```js
const gameModules = {
    'pitch-quest': () => import('./metrics/pitch-quest.js'),
    'rhythm-dash': () => import('./metrics/rhythm-dash.js'),
    // ...
};

const loadGameMetrics = async (gameId) => {
    const loader = gameModules[gameId];
    if (!loader) return;
    const mod = await loader();
    mod.init();
};
```

`app.js` `loadForView` calls `loadGameMetrics` with the specific game ID extracted from the view hash.

Each per-game module exports an `init()` function that sets up event listeners and DOM bindings for that game only.

### M14: Per-Game CSS Split

Each per-game JS module imports its own CSS:
```js
// src/games/metrics/pitch-quest.js
import './pitch-quest.css';
import { cachedEl, formatStars } from './shared.js';
```

Vite automatically code-splits the CSS alongside the JS chunk.

CSS extraction process:
- Identify game-specific selectors (`.game-pitch-quest`, `.pitch-quest-*`, etc.)
- Move to `src/games/metrics/pitch-quest.css`
- Keep shared game chrome in `app.css` (`.game-view`, `.game-header`, `.glass`, timer, score display)

Shared game base styles remain in `app.css`:
- `.game-view` layout
- `.game-header`, `.game-score`, `.game-timer` base styles
- Glass morphism and shared UI patterns

### H12: HTML Template Extraction

Move 13 game view sections from inline `index.html` to individual template files:

```
src/templates/games/pitch-quest.html
src/templates/games/rhythm-dash.html
// ... 13 files
```

Extend build script (`scripts/build-games-html.js`) to:
1. Read all `src/templates/games/*.html` files
2. Concatenate them
3. Inject between `<!-- GAME_VIEWS_START -->` / `<!-- GAME_VIEWS_END -->` markers

Add markers to `index.html` around the game views section (similar to existing `SONGS_GRID_START`/`SONG_VIEWS_START` markers).

Register in `package.json` prebuild: `node scripts/build-songs-html.js && node scripts/build-games-html.js`

Production output unchanged — still a single index.html with all views. The win is DX: editing a game view means editing a ~60-line file instead of scrolling through 3,344 lines.

## What This Does NOT Change

- Hash-based navigation — all views still present in DOM at load time
- Service worker caching strategy — same precache behavior
- Offline functionality — no runtime fetches for HTML/CSS
- Song views — already generated by build-songs-html.js, no changes needed

## Expected Impact

| Item | Before | After | Savings |
|------|--------|-------|---------|
| M16 | 47KB WASM at boot | WASM on first use | 47KB (20KB gzip) deferred |
| M13 | 44KB single JS chunk | ~3KB per game | ~41KB deferred per game visit |
| M14 | 123KB single CSS | ~85KB base + ~3KB per game | ~38KB deferred |
| H12 | 3,344-line index.html | ~2,100-line index.html + 13 templates | DX improvement only |
